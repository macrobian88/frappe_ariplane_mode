{% extends "templates/web.html" %}

{% block title %}Airport Shop Portal - Available Retail Spaces{% endblock %}

{% block head_include %}
<meta name="description" content="Discover premium retail opportunities at our world-class airport. Browse available shops and submit applications online.">
<meta name="keywords" content="airport shops, retail space, airport retail, shop lease, commercial space">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
/* Shop Portal Styles */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
}

.airport-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 80px 0;
    text-align: center;
    margin-bottom: 0;
}

.airport-hero h1 {
    font-size: 3.5rem;
    font-weight: bold;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.airport-hero .lead {
    font-size: 1.3rem;
    opacity: 0.9;
    max-width: 600px;
    margin: 0 auto;
}

.filter-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin: -30px auto 30px;
    max-width: 1000px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 10;
}

.shop-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    margin-bottom: 25px;
}

.shop-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.shop-card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
}

.shop-card-body {
    padding: 20px;
}

.shop-price {
    text-align: center;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.shop-price .price {
    font-size: 1.8rem;
    font-weight: bold;
    color: #28a745;
}

.btn-airport {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    border-radius: 25px;
    padding: 10px 25px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-airport:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    color: white;
}

.btn-outline-airport {
    border: 2px solid #667eea;
    color: #667eea;
    background: transparent;
    border-radius: 25px;
    padding: 8px 20px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-outline-airport:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.alert {
    border-radius: 10px;
    border: none;
}

@media (max-width: 768px) {
    .airport-hero h1 {
        font-size: 2.5rem;
    }
    
    .shop-card {
        margin-bottom: 20px;
    }
}
</style>
{% endblock %}

{% block page_content %}
<!-- Hero Section -->
<div class="airport-hero">
    <div class="container">
        <h1><i class="fas fa-plane"></i> Airport Shop Portal</h1>
        <p class="lead">Discover premium retail opportunities at our world-class airport</p>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <!-- Filters Section -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label"><i class="fas fa-store"></i> Shop Type</label>
                <select class="form-select" id="shopTypeFilter">
                    <option value="">All Shop Types</option>
                    <option value="Food Court">Food Court</option>
                    <option value="Duty Free">Duty Free</option>
                    <option value="Normal">Normal Retail</option>
                    <option value="Stall">Stall</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label"><i class="fas fa-expand-arrows-alt"></i> Area Size</label>
                <select class="form-select" id="areaSizeFilter">
                    <option value="">All Sizes</option>
                    <option value="small">Small (< 500 sq ft)</option>
                    <option value="medium">Medium (500-1000 sq ft)</option>
                    <option value="large">Large (> 1000 sq ft)</option>
                </select>
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label"><i class="fas fa-search"></i> Search</label>
                <input type="text" class="form-control" id="searchShops" placeholder="Search shops...">
            </div>
        </div>
    </div>
    
    <!-- Stats Section -->
    <div class="row mb-4" id="statsSection" style="display: none;">
        <div class="col-md-4">
            <div class="card text-center border-0 bg-primary text-white">
                <div class="card-body">
                    <h3 id="totalShops">0</h3>
                    <p>Available Shops</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center border-0 bg-success text-white">
                <div class="card-body">
                    <h3 id="avgRent">â‚¹0</h3>
                    <p>Average Rent</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center border-0 bg-info text-white">
                <div class="card-body">
                    <h3 id="totalArea">0</h3>
                    <p>Total Area (sq ft)</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Shop Cards Container -->
    <div class="row" id="shopsContainer">
        <!-- Shops will be loaded here -->
    </div>
    
    <!-- Loading Spinner -->
    <div class="text-center mt-4" id="loadingSpinner">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading available shops...</p>
    </div>
</div>

<!-- Shop Details Modal -->
<div class="modal fade" id="shopDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shopModalTitle">Shop Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="shopModalBody">
                <!-- Shop details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-airport" id="applyForShopBtn">
                    <i class="fas fa-paper-plane"></i> Apply Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Application Modal -->
<div class="modal fade" id="applicationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-alt"></i> Apply for Shop</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="applicationForm">
                    <div class="mb-3">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-control" name="lead_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email Address *</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" name="phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Business Type *</label>
                        <select class="form-select" name="business_type" required>
                            <option value="">Select Business Type</option>
                            <option value="Restaurant">Restaurant</option>
                            <option value="Retail">Retail</option>
                            <option value="Services">Services</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Fashion">Fashion</option>
                            <option value="Books & Magazines">Books & Magazines</option>
                            <option value="Gifts & Souvenirs">Gifts & Souvenirs</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Business Plan / Message</label>
                        <textarea class="form-control" name="message" rows="4" 
                                  placeholder="Tell us about your business plan and why you're interested in this location..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-airport" id="submitApplication">
                    <i class="fas fa-paper-plane"></i> Submit Application
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let allShops = [];
let currentShop = null;

document.addEventListener('DOMContentLoaded', function() {
    loadAvailableShops();
    setupEventListeners();
});

function loadAvailableShops() {
    document.getElementById('loadingSpinner').style.display = 'block';
    
    fetch('/api/method/airplane_mode.api.shop_portal.get_available_shops')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingSpinner').style.display = 'none';
            if (data.message && data.message.status === 'success') {
                allShops = data.message.shops;
                displayShops(allShops);
                updateStats(allShops);
            } else {
                showError('Failed to load shops');
            }
        })
        .catch(error => {
            document.getElementById('loadingSpinner').style.display = 'none';
            showError('Failed to connect to server');
            console.error('Error:', error);
        });
}

function displayShops(shops) {
    const container = document.getElementById('shopsContainer');
    container.innerHTML = '';
    
    if (shops.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-store-slash fa-4x text-muted mb-3"></i>
                <h4>No shops available</h4>
                <p class="text-muted">Please check back later or contact us for more information.</p>
            </div>
        `;
        return;
    }
    
    shops.forEach(shop => {
        const shopCard = createShopCard(shop);
        container.appendChild(shopCard);
    });
}

function createShopCard(shop) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4 mb-4';
    
    col.innerHTML = `
        <div class="shop-card" data-shop-id="${shop.name}">
            <div class="shop-card-header">
                <h3 class="mb-1">${shop.shop_name}</h3>
                <small><i class="fas fa-tag"></i> ${shop.shop_type}</small>
            </div>
            <div class="shop-card-body">
                <div class="mb-3">
                    <p class="mb-1"><i class="fas fa-map-marker-alt text-primary"></i> ${shop.location}</p>
                    <p class="mb-1"><i class="fas fa-expand-arrows-alt text-primary"></i> ${shop.area_sqft} sq ft</p>
                    <p class="mb-0"><i class="fas fa-building text-primary"></i> ${shop.terminal} - Floor ${shop.floor_level}</p>
                </div>
                ${shop.shop_description ? `<p class="text-muted small mb-3">${shop.shop_description}</p>` : ''}
                <div class="shop-price">
                    <div class="price">â‚¹${Number(shop.total_monthly_rent).toLocaleString()}</div>
                    <small class="text-muted">per month</small>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-airport" onclick="viewShopDetails('${shop.name}')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                    <button class="btn btn-airport" onclick="applyForShop('${shop.name}')">
                        <i class="fas fa-paper-plane"></i> Apply Now
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

function updateStats(shops) {
    const totalShops = shops.length;
    const totalRent = shops.reduce((sum, shop) => sum + Number(shop.total_monthly_rent), 0);
    const avgRent = totalShops > 0 ? totalRent / totalShops : 0;
    const totalArea = shops.reduce((sum, shop) => sum + Number(shop.area_sqft), 0);
    
    document.getElementById('totalShops').textContent = totalShops;
    document.getElementById('avgRent').textContent = 'â‚¹' + Math.round(avgRent).toLocaleString();
    document.getElementById('totalArea').textContent = totalArea.toLocaleString();
    document.getElementById('statsSection').style.display = 'block';
}

function setupEventListeners() {
    // Search functionality
    document.getElementById('searchShops').addEventListener('input', filterShops);
    
    // Filter functionality
    document.getElementById('shopTypeFilter').addEventListener('change', filterShops);
    document.getElementById('areaSizeFilter').addEventListener('change', filterShops);
    
    // Application form submission
    document.getElementById('submitApplication').addEventListener('click', submitApplication);
    
    // Apply button in modal
    document.getElementById('applyForShopBtn').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('shopDetailsModal'));
        modal.hide();
        setTimeout(() => {
            const appModal = new bootstrap.Modal(document.getElementById('applicationModal'));
            appModal.show();
        }, 300);
    });
}

function filterShops() {
    const searchTerm = document.getElementById('searchShops').value.toLowerCase();
    const shopType = document.getElementById('shopTypeFilter').value;
    const areaSize = document.getElementById('areaSizeFilter').value;
    
    let filteredShops = allShops.filter(shop => {
        // Search filter
        const matchesSearch = shop.shop_name.toLowerCase().includes(searchTerm) ||
                             shop.location.toLowerCase().includes(searchTerm) ||
                             shop.shop_type.toLowerCase().includes(searchTerm);
        
        // Shop type filter
        const matchesType = !shopType || shop.shop_type === shopType;
        
        // Area size filter
        let matchesSize = true;
        if (areaSize) {
            const area = parseInt(shop.area_sqft);
            switch(areaSize) {
                case 'small':
                    matchesSize = area < 500;
                    break;
                case 'medium':
                    matchesSize = area >= 500 && area <= 1000;
                    break;
                case 'large':
                    matchesSize = area > 1000;
                    break;
            }
        }
        
        return matchesSearch && matchesType && matchesSize;
    });
    
    displayShops(filteredShops);
    updateStats(filteredShops);
}

function viewShopDetails(shopId) {
    currentShop = allShops.find(shop => shop.name === shopId);
    if (!currentShop) return;
    
    document.getElementById('shopModalTitle').textContent = currentShop.shop_name;
    document.getElementById('shopModalBody').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-info-circle"></i> Basic Information</h6>
                <table class="table table-sm">
                    <tr><td>Shop Type:</td><td><span class="badge bg-primary">${currentShop.shop_type}</span></td></tr>
                    <tr><td>Location:</td><td>${currentShop.location}</td></tr>
                    <tr><td>Terminal:</td><td>${currentShop.terminal}</td></tr>
                    <tr><td>Floor:</td><td>${currentShop.floor_level}</td></tr>
                    <tr><td>Area:</td><td><strong>${currentShop.area_sqft} sq ft</strong></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-rupee-sign"></i> Pricing</h6>
                <table class="table table-sm">
                    <tr><td>Rent per sq ft:</td><td>â‚¹${currentShop.rent_per_sqft}</td></tr>
                    <tr><td><strong>Monthly Rent:</strong></td><td><strong class="text-success fs-5">â‚¹${Number(currentShop.total_monthly_rent).toLocaleString()}</strong></td></tr>
                </table>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb"></i> 
                    <strong>Prime Location!</strong> High foot traffic area with excellent visibility.
                </div>
            </div>
        </div>
        ${currentShop.shop_description ? `
            <div class="mt-3">
                <h6><i class="fas fa-file-alt"></i> Description</h6>
                <p class="text-muted">${currentShop.shop_description}</p>
            </div>
        ` : ''}
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('shopDetailsModal'));
    modal.show();
}

function applyForShop(shopId) {
    if (shopId) {
        currentShop = allShops.find(shop => shop.name === shopId);
    }
    
    if (!currentShop) {
        showError('Please select a shop first');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('applicationModal'));
    modal.show();
}

function submitApplication() {
    if (!currentShop) {
        showError('No shop selected');
        return;
    }
    
    const formData = new FormData(document.getElementById('applicationForm'));
    const leadData = Object.fromEntries(formData.entries());
    
    // Validate required fields
    if (!leadData.lead_name || !leadData.email || !leadData.phone || !leadData.business_type) {
        showError('Please fill all required fields');
        return;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(leadData.email)) {
        showError('Please enter a valid email address');
        return;
    }
    
    const submitBtn = document.getElementById('submitApplication');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    fetch('/api/method/airplane_mode.api.shop_portal.submit_shop_application', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            shop_id: currentShop.name,
            lead_data: JSON.stringify(leadData)
        })
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Application';
        
        if (data.message && data.message.status === 'success') {
            const modal = bootstrap.Modal.getInstance(document.getElementById('applicationModal'));
            modal.hide();
            showSuccess(data.message.message);
            document.getElementById('applicationForm').reset();
        } else {
            showError(data.message?.message || 'Failed to submit application');
        }
    })
    .catch(error => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Application';
        showError('Failed to submit application');
        console.error('Error:', error);
    });
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <i class="fas fa-exclamation-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}
</script>
{% endblock %}